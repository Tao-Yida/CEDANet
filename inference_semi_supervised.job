#!/bin/bash

# ----------- SLURM æŒ‡ä»¤ï¼ˆä¿ç•™å¿…è¦éƒ¨åˆ†ï¼‰ ------------
#SBATCH --job-name=train_bvm_semi_supervised
#SBATCH --partition=gpu_mig
#SBATCH --gres=gpu:1
#SBATCH --time=24:00:00
#SBATCH --mem=24G
#SBATCH --cpus-per-task=6
#SBATCH --output=logs_out/trans_bvm_semi_train_%j.out
#SBATCH --error=logs_err/trans_bvm_semi_train_%j.err

# ============================================================================
# BVM åŠç›‘ç£è®­ç»ƒè„šæœ¬å‚æ•°è¯´æ˜
# ============================================================================

# --------------- åŸºç¡€è®­ç»ƒå‚æ•° ---------------
# --epoch:                è®­ç»ƒè½®æ•° (é»˜è®¤: 50)
# --batchsize:            æ¯æ‰¹æ¬¡æ ·æœ¬æ•°é‡ (é»˜è®¤: 8)
# --trainsize:            è¾“å…¥å›¾åƒåˆ†è¾¨ç‡ (é»˜è®¤: 352x352)

# --------------- ä¼˜åŒ–å™¨å‚æ•° ---------------
# --lr_gen:               ç”Ÿæˆå™¨å­¦ä¹ ç‡ (é»˜è®¤: 5e-5)
# --beta:                 Adamä¼˜åŒ–å™¨betaå‚æ•° (é»˜è®¤: 0.5)
# --clip:                 æ¢¯åº¦è£å‰ªè¾¹é™…ï¼Œé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸ (é»˜è®¤: 0.5)
# --decay_rate:           å­¦ä¹ ç‡è¡°å‡ç‡ (é»˜è®¤: 0.8)
# --decay_epoch:          å­¦ä¹ ç‡è¡°å‡å‘¨æœŸ/è€å¿ƒå€¼ (é»˜è®¤: 12)

# --------------- æ¨¡å‹æ¶æ„å‚æ•° ---------------
# --feat_channel:         é‡è¦æ€§ç‰¹å¾çš„é€šé“æ•° (é»˜è®¤: 32)
# --latent_dim:           æ½œåœ¨ç»´åº¦ (é»˜è®¤: 3)
# --num_filters:          æœ€ç»ˆå¯¹æ¯”æŸå¤±ç‰¹å®šå±‚çš„é€šé“æ•° (é»˜è®¤: 16)

# --------------- æŸå¤±å‡½æ•°æƒé‡ ---------------
# --reg_weight:           L2æ­£åˆ™åŒ–é¡¹çš„æƒé‡ (é»˜è®¤: 1e-4)
# --lat_weight:           æ½œåœ¨æŸå¤±çš„æƒé‡ (é»˜è®¤: 2.0)
# --vae_loss_weight:      VAEæŸå¤±çš„æƒé‡ (é»˜è®¤: 1.0)
# --contrastive_loss_weight: å¯¹æ¯”æŸå¤±çš„æƒé‡ (é»˜è®¤: 0.2)

# --------------- åŠç›‘ç£å­¦ä¹ ç‰¹æœ‰å‚æ•° ---------------
# --inter:                æ˜¯å¦è¿›è¡Œè·¨å›¾åƒåƒç´ åŒ¹é… (é»˜è®¤: False)
#                        å¦‚æœä¸ºTrueï¼Œåˆ™åœ¨ä¸åŒå›¾åƒä¹‹é—´è¿›è¡ŒåŒ¹é…
#                        å¦åˆ™åœ¨åŒä¸€å›¾åƒå†…è¿›è¡ŒåŒ¹é…
# --no_samples:           å¯¹æ¯”æŸå¤±ä¸­è€ƒè™‘çš„åƒç´ æ•°é‡ (é»˜è®¤: 50)

# --------------- æ•°æ®é›†è·¯å¾„ ---------------
# --labeled_dataset_path:   æ ‡æ³¨æ•°æ®é›†è·¯å¾„ (é»˜è®¤: data/SMOKE5K_Dataset/SMOKE5K/train)
# --unlabeled_dataset_path: æ— æ ‡æ³¨æ•°æ®é›†è·¯å¾„ (é»˜è®¤: data/SMOKE5K_Dataset/SMOKE5K/weak_supervision)
# --pretrained_weights:     é¢„è®­ç»ƒæƒé‡è·¯å¾„ (é»˜è®¤: None)
# --save_model_path:        æ¨¡å‹ä¿å­˜è·¯å¾„ (é»˜è®¤: models/semi-supervision)

# --------------- æ ¡éªŒå’Œæ—©åœå‚æ•° ---------------
# --val_split:            æ ‡æ³¨æ•°æ®é›†ä¸­ç”¨äºæ ¡éªŒçš„æ¯”ä¾‹ (é»˜è®¤: 0.2)
# --patience:             æ—©åœè€å¿ƒå€¼ (é»˜è®¤: 15)
# --min_delta:            æ—©åœæœ€å°æ”¹å–„å€¼ (é»˜è®¤: 0.001)
# --enable_validation:    å¯ç”¨åœ¨æ ‡æ³¨æ•°æ®å­é›†ä¸Šçš„æ ¡éªŒ (é»˜è®¤: False)

# --------------- æ•°æ®å¢å¼ºå’Œå¯é‡ç°æ€§å‚æ•° ---------------
# --aug:                  å¯ç”¨æ— æ ‡æ³¨æ•°æ®çš„æ•°æ®å¢å¼º (é»˜è®¤å¯ç”¨ï¼Œé™¤éä½¿ç”¨--no_augç¦ç”¨)
# --no_aug:               æ˜¾å¼ç¦ç”¨æ•°æ®å¢å¼º
# --freeze:               å†»ç»“æ‰€æœ‰éšæœºæ€§ä»¥ç¡®ä¿å®Œå…¨å¯é‡ç° (é»˜è®¤: False)
#                        æ³¨æ„ï¼šå½“ä½¿ç”¨--freezeæ—¶ï¼Œæ•°æ®å¢å¼ºä¼šè¢«è‡ªåŠ¨ç¦ç”¨
# --random_seed:          éšæœºç§å­ (é»˜è®¤: 42)

# ============================================================================

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs_out logs_err

# åŠ è½½æ‰§è¡Œç¯å¢ƒ
module purge
module load 2024
source ~/anaconda3/etc/profile.d/conda.sh
source activate dl2024 || { echo "Failed to activate Conda env"; exit 1; }

# æ‰§è¡ŒåŠç›‘ç£è®­ç»ƒè„šæœ¬
#
# å®éªŒé…ç½®ï¼šSMOKE5Kæ ‡æ³¨æ•°æ®(å®Œæ•´è®­ç»ƒ) + ijmondä¼ªæ ‡ç­¾æ•°æ®(è®­ç»ƒ+ç›®æ ‡åŸŸéªŒè¯)
# ğŸ¯ å…³é”®ä¿®æ”¹ï¼šéªŒè¯åœ¨ç›®æ ‡åŸŸ(ijmond)ä¸Šè¿›è¡Œï¼Œè€ŒéæºåŸŸ(SMOKE5K)
python src/bvm_training/trans_bvm_self_supervised/train.py \
--epoch 100 \
--batchsize 8 \
--trainsize 352 \
--lr_gen 5e-5 \
--labeled_dataset_path "data/SMOKE5K_Dataset/SMOKE5K/train" \
--unlabeled_dataset_path "data/ijmond_camera/SMOKE5K-full/non_constraint" \
--save_model_path "models/semi-supervision/SMOKE5K-ijmond-camera-on-SMOKE5K" \
--no_samples 500 \
--aug \
--enable_validation \
--val_split 0.2 \
--patience 25 \
--min_delta 0.001 \
--random_seed 422
# 3. ä¸“å®¶æ ‡ç­¾çº¦æŸç”Ÿæˆï¼ˆè‡ªç›‘ç£æ¨¡å‹ï¼‰
echo "æ‰§è¡Œä¸“å®¶æ ‡ç­¾çº¦æŸä¼ªæ ‡ç­¾ç”Ÿæˆï¼ˆè‡ªç›‘ç£æ¨¡å‹ï¼‰..."
python src/bvm_training/trans_bvm_self_supervised/inference.py \
--videos_path "data/ijmond_camera/videos" \
--output_path "data/ijmond_camera/SMOKE5K-self" \
--pretrained_weights "models/semi-supervision/SMOKE5K_Dataset_SMOKE5K_train_ssl_SMOKE5K_Dataset_SMOKE5K_weak_supervision/SMOKE5K_Dataset_SMOKE5K_train_ssl_SMOKE5K_Dataset_SMOKE5K_weak_supervision_best_model.pth" \
--num_filters 16 \
--context_frames 2 \
--threshold 0.7 \
--constraint_type expert \
--video_labels_csv "data/ijmond_camera/video_labels.csv"

echo "æ‰€æœ‰è‡ªç›‘ç£æ¨¡å‹ä¼ªæ ‡ç­¾ç”Ÿæˆä»»åŠ¡å®Œæˆï¼"
echo ""
echo "è‡ªç›‘ç£æ¨¡å‹ç‰¹ç‚¹ï¼š"
echo "- è®­ç»ƒæ—¶ï¼šè¿”å›å¤šä¸ªè¾“å‡º (sal_init_post, sal_ref_post, sal_init_prior, sal_ref_prior, latent_loss, output_post, output_prior)"
echo "- æ¨ç†æ—¶ï¼šè¿”å›å•ä¸ª prob_pred ï¼ˆä½¿ç”¨å…ˆéªŒé¢„æµ‹ï¼‰"
echo "- æ”¯æŒçº¦æŸæœºåˆ¶ï¼Œä¸æ¨ç†æ¨¡å¼å…¼å®¹"
echo ""
echo "ç»“æœç›®å½•ç»“æ„ï¼š"
echo "data/ijmond_camera/SMOKE5K-self/"
echo "â”œâ”€â”€ non_constraint/"
echo "â”‚   â”œâ”€â”€ img/     (åŸå§‹å›¾åƒ)"
echo "â”‚   â”œâ”€â”€ pl/      (ä¼ªæ ‡ç­¾)"
echo "â”‚   â””â”€â”€ trans/   (é€å…‰ç‡å›¾)"
echo "â”œâ”€â”€ citizen_constraint/"
echo "â”‚   â”œâ”€â”€ img/"
echo "â”‚   â”œâ”€â”€ pl/"
echo "â”‚   â””â”€â”€ trans/"
echo "â””â”€â”€ expert_constraint/"
echo "    â”œâ”€â”€ img/"
echo "    â”œâ”€â”€ pl/"
echo "    â””â”€â”€ trans/"
