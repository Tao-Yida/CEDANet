#!/bin/bash

# ----------- SLURM æŒ‡ä»¤ï¼ˆä¿ç•™å¿…è¦éƒ¨åˆ†ï¼‰ ------------
#SBATCH --job-name=train_bvm_multi_datasets
#SBATCH --partition=gpu_mig
#SBATCH --gres=gpu:1
#SBATCH --time=18:00:00
#SBATCH --mem=16G
#SBATCH --cpus-per-task=4
#SBATCH --output=logs_out/trans_bvm_multi_train_%j.out
#SBATCH --error=logs_err/trans_bvm_multi_train_%j.err

# ============================================================================
# BVM è®­ç»ƒè„šæœ¬å‚æ•°è¯´æ˜ï¼ˆä¸ train.py ä¿æŒåŒæ­¥ï¼‰
# ============================================================================

# --------------- åŸºç¡€è®­ç»ƒå‚æ•° ---------------
# --epoch:             è®­ç»ƒè½®æ•° (é»˜è®¤: 50)
# --batchsize:         æ¯æ‰¹æ¬¡æ ·æœ¬æ•°é‡ (é»˜è®¤: 7)
# --trainsize:         è¾“å…¥å›¾åƒåˆ†è¾¨ç‡ (é»˜è®¤: 352)

# --------------- ä¼˜åŒ–å™¨å‚æ•° ---------------
# --lr_gen:            ç”Ÿæˆå™¨å­¦ä¹ ç‡ (é»˜è®¤: 2.5e-5)
# --lr_des:            æè¿°å™¨å­¦ä¹ ç‡ (é»˜è®¤: 2.5e-5)
# --beta:              Adamä¼˜åŒ–å™¨betaå‚æ•° (é»˜è®¤: 0.5)
# --clip:              æ¢¯åº¦è£å‰ªé˜ˆå€¼ (é»˜è®¤: 0.5)
# --decay_rate:        å­¦ä¹ ç‡è¡°å‡å› å­ (é»˜è®¤: 0.9)
# --decay_epoch:       å­¦ä¹ ç‡plateauè€å¿ƒ (é»˜è®¤: 6)

# --------------- æ¨¡å‹æ¶æ„å‚æ•° ---------------
# --gen_reduced_channel:  ç”Ÿæˆå™¨é€šé“æ•° (é»˜è®¤: 32)
# --des_reduced_channel:  æè¿°å™¨é€šé“æ•° (é»˜è®¤: 64)
# --feat_channel:         æ˜¾è‘—æ€§ç‰¹å¾é€šé“æ•° (é»˜è®¤: 32)
# --latent_dim:           æ½œåœ¨ç©ºé—´ç»´åº¦ (é»˜è®¤: 3)

# --------------- EBM ç›¸å…³å‚æ•° ---------------
# --langevin_step_num_des:  Langevinæ­¥éª¤æ•° (é»˜è®¤: 10)
# --langevin_step_size_des: Langevinæ­¥é•¿ (é»˜è®¤: 0.026)
# --energy_form:            èƒ½é‡å‡½æ•°å½¢å¼ (é»˜è®¤: identity)
#                          é€‰é¡¹: tanh | sigmoid | identity | softplus

# --------------- æŸå¤±æƒé‡å‚æ•° ---------------
# --sm_weight:         å¹³æ»‘æ€§æŸå¤±æƒé‡ (é»˜è®¤: 0.1)
# --reg_weight:        L2æ­£åˆ™åŒ–æŸå¤±æƒé‡ (é»˜è®¤: 1e-4)
# --lat_weight:        æ½œåœ¨æŸå¤±æƒé‡ (é»˜è®¤: 10.0)
# --vae_loss_weight:   VAEæŸå¤±æƒé‡ (é»˜è®¤: 0.4)

# --------------- æ•°æ®å’Œä¿å­˜è·¯å¾„ ---------------
# --dataset_path:      è®­ç»ƒæ•°æ®é›†è·¯å¾„ (é»˜è®¤: data/ijmond_data/train)
# --save_model_path:   æ¨¡å‹ä¿å­˜è·¯å¾„ (é»˜è®¤: models/full-supervision)
# --pretrained_weights: é¢„è®­ç»ƒæƒé‡è·¯å¾„ (é»˜è®¤: None)

# --------------- æ ¡éªŒç›¸å…³å‚æ•° ---------------
# --val_split:         æ ¡éªŒé›†æ¯”ä¾‹ (é»˜è®¤: 0.2)
# --patience:          æ—©åœè€å¿ƒå€¼ (é»˜è®¤: 15)
# --min_delta:         æ—©åœæœ€å°æ”¹å–„é˜ˆå€¼ (é»˜è®¤: 0.001)

# --------------- æ•°æ®å¢å¼ºå’Œå¯é‡ç°æ€§ ---------------
# --aug:               å¯ç”¨æ•°æ®å¢å¼º (é»˜è®¤: False, åŠ  --aug å¯ç”¨)
# --freeze:            å›ºå®šéšæœºæ€§ (é»˜è®¤: False, åŠ  --freeze å¯ç”¨)
# --random_seed:       éšæœºç§å­ (é»˜è®¤: 42)

# ============================================================================

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs_out logs_err

# åŠ è½½æ‰§è¡Œç¯å¢ƒ
module purge
module load 2024
source ~/anaconda3/etc/profile.d/conda.sh
source activate dl2024 || { echo "Failed to activate Conda env"; exit 1; }

# ============================================================================
# å¤šæ•°æ®é›†è®­ç»ƒé…ç½® - æ§åˆ¶å˜é‡å®éªŒ
# ============================================================================

# é€šç”¨è®­ç»ƒå‚æ•°ï¼ˆæ‰€æœ‰æ¨¡å‹ä½¿ç”¨ç›¸åŒå‚æ•°ç¡®ä¿æ§åˆ¶å˜é‡ï¼‰
COMMON_PARAMS="--epoch 50 --batchsize 8 --trainsize 352 --lr_gen 2.5e-5 --lr_des 2.5e-5 --beta 0.5 --clip 0.5 --decay_rate 0.9 --decay_epoch 6 --gen_reduced_channel 32 --des_reduced_channel 64 --feat_channel 32 --latent_dim 3 --langevin_step_num_des 10 --langevin_step_size_des 0.026 --energy_form identity --sm_weight 0.1 --reg_weight 1e-4 --lat_weight 10.0 --vae_loss_weight 0.4 --val_split 0.2 --patience 15 --min_delta 0.001 --aug --random_seed 42"

echo "=========================================="
echo "å¼€å§‹å¤šæ•°æ®é›†BVMæ¨¡å‹è®­ç»ƒ"
echo "æ—¶é—´: $(date)"
echo "=========================================="

# ============================================================================
# æ¨¡å‹ 1: SMOKE5K å®Œå…¨ç›‘ç£è®­ç»ƒæ•°æ®é›†
# ============================================================================
echo ""
echo "ğŸš€ [1/3] å¼€å§‹è®­ç»ƒ SMOKE5K å®Œå…¨ç›‘ç£æ¨¡å‹..."
echo "æ•°æ®é›†: data/SMOKE5K_Dataset/SMOKE5K/train"
echo "ä¿å­˜è·¯å¾„: models/full-supervision/SMOKE5K-supervised"
echo "------------------------------------------"

python ijmond-camera-ai/bvm_training/trans_bvm/train.py \
$COMMON_PARAMS \
--dataset_path "data/SMOKE5K_Dataset/SMOKE5K/train" \
--save_model_path "models/full-supervision/SMOKE5K-supervised"

TRAIN1_EXIT_CODE=$?
if [ $TRAIN1_EXIT_CODE -eq 0 ]; then
    echo "âœ… SMOKE5K å®Œå…¨ç›‘ç£æ¨¡å‹è®­ç»ƒå®Œæˆ"
else
    echo "âŒ SMOKE5K å®Œå…¨ç›‘ç£æ¨¡å‹è®­ç»ƒå¤±è´¥ï¼Œé€€å‡ºç : $TRAIN1_EXIT_CODE"
    echo "ç»§ç»­ä¸‹ä¸€ä¸ªæ¨¡å‹è®­ç»ƒ..."
fi

# ============================================================================
# æ¨¡å‹ 2: SMOKE5K å¼±ç›‘ç£è®­ç»ƒæ•°æ®é›†
# ============================================================================
echo ""
echo "ğŸš€ [2/3] å¼€å§‹è®­ç»ƒ SMOKE5K å¼±ç›‘ç£æ¨¡å‹..."
echo "æ•°æ®é›†: data/SMOKE5K_Dataset/SMOKE5K/weak_supervision"
echo "ä¿å­˜è·¯å¾„: models/full-supervision/SMOKE5K-weak-supervised"
echo "------------------------------------------"

python ijmond-camera-ai/bvm_training/trans_bvm/train.py \
$COMMON_PARAMS \
--dataset_path "data/SMOKE5K_Dataset/SMOKE5K/weak_supervision" \
--save_model_path "models/full-supervision/SMOKE5K-weak-supervised"

TRAIN2_EXIT_CODE=$?
if [ $TRAIN2_EXIT_CODE -eq 0 ]; then
    echo "âœ… SMOKE5K å¼±ç›‘ç£æ¨¡å‹è®­ç»ƒå®Œæˆ"
else
    echo "âŒ SMOKE5K å¼±ç›‘ç£æ¨¡å‹è®­ç»ƒå¤±è´¥ï¼Œé€€å‡ºç : $TRAIN2_EXIT_CODE"
    echo "ç»§ç»­ä¸‹ä¸€ä¸ªæ¨¡å‹è®­ç»ƒ..."
fi

# ============================================================================
# æ¨¡å‹ 3: IJmond æµ‹è¯•æ•°æ®é›†
# ============================================================================
echo ""
echo "ğŸš€ [3/3] å¼€å§‹è®­ç»ƒ IJmond Testæ¨¡å‹..."
echo "æ•°æ®é›†: data/ijmond_data/test"
echo "ä¿å­˜è·¯å¾„: models/full-supervision/IJmond-test"
echo "------------------------------------------"

python ijmond-camera-ai/bvm_training/trans_bvm/train.py \
$COMMON_PARAMS \
--dataset_path "data/ijmond_data/test" \
--save_model_path "models/full-supervision/IJmond-test"

TRAIN3_EXIT_CODE=$?
if [ $TRAIN3_EXIT_CODE -eq 0 ]; then
    echo "âœ… IJmond æ¨¡å‹è®­ç»ƒå®Œæˆ"
else
    echo "âŒ IJmond æ¨¡å‹è®­ç»ƒå¤±è´¥ï¼Œé€€å‡ºç : $TRAIN3_EXIT_CODE"
fi

# ============================================================================
# è®­ç»ƒæ€»ç»“
# ============================================================================
echo ""
echo "=========================================="
echo "å¤šæ•°æ®é›†è®­ç»ƒå®Œæˆæ€»ç»“"
echo "æ—¶é—´: $(date)"
echo "=========================================="
echo "è®­ç»ƒç»“æœ:"
echo "  [1] SMOKE5K å®Œå…¨ç›‘ç£: $([ $TRAIN1_EXIT_CODE -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
echo "  [2] SMOKE5K å¼±ç›‘ç£:   $([ $TRAIN2_EXIT_CODE -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
echo "  [3] IJmond æµ‹è¯•:      $([ $TRAIN3_EXIT_CODE -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
echo ""
echo "æ¨¡å‹ä¿å­˜ä½ç½®:"
echo "  ğŸ”¹ models/full-supervision/SMOKE5K-supervised/"
echo "  ğŸ”¹ models/full-supervision/SMOKE5K-weak-supervised/"
echo "  ğŸ”¹ models/full-supervision/IJmond-test/"
echo ""
echo "æ‰€æœ‰è®­ç»ƒä½¿ç”¨ç›¸åŒå‚æ•°ä»¥ç¡®ä¿æ§åˆ¶å˜é‡:"
echo "  â€¢ æ•°æ®å¢å¼º: å¯ç”¨ (--aug)"
echo "  â€¢ éšæœºç§å­: 42 (ç¡®ä¿å¯é‡ç°æ€§)"
echo "  â€¢ è®­ç»ƒè½®æ•°: 50"
echo "  â€¢ æ‰¹æ¬¡å¤§å°: 7"
echo "  â€¢ å­¦ä¹ ç‡: 2.5e-5"
echo "  â€¢ æ—©åœç­–ç•¥: å¯ç”¨ (patience=15)"
echo "=========================================="

# æ€»ä½“é€€å‡ºç 
OVERALL_SUCCESS=0
if [ $TRAIN1_EXIT_CODE -ne 0 ] || [ $TRAIN2_EXIT_CODE -ne 0 ] || [ $TRAIN3_EXIT_CODE -ne 0 ]; then
    OVERALL_SUCCESS=1
    echo "âš ï¸ éƒ¨åˆ†è®­ç»ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶"
fi

exit $OVERALL_SUCCESS