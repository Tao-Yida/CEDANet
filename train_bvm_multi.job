#!/bin/bash

# ----------- SLURM 指令（保留必要部分） ------------
#SBATCH --job-name=train_bvm_multi_datasets
#SBATCH --partition=gpu_mig
#SBATCH --gres=gpu:1
#SBATCH --time=18:00:00
#SBATCH --mem=16G
#SBATCH --cpus-per-task=4
#SBATCH --output=logs_out/trans_bvm_multi_train_%j.out
#SBATCH --error=logs_err/trans_bvm_multi_train_%j.err

# ============================================================================
# BVM 训练脚本参数说明（与 train.py 保持同步）
# ============================================================================

# --------------- 基础训练参数 ---------------
# --epoch:             训练轮数 (默认: 50)
# --batchsize:         每批次样本数量 (默认: 7)
# --trainsize:         输入图像分辨率 (默认: 352)

# --------------- 优化器参数 ---------------
# --lr_gen:            生成器学习率 (默认: 2.5e-5)
# --lr_des:            描述器学习率 (默认: 2.5e-5)
# --beta:              Adam优化器beta参数 (默认: 0.5)
# --clip:              梯度裁剪阈值 (默认: 0.5)
# --decay_rate:        学习率衰减因子 (默认: 0.9)
# --decay_epoch:       学习率plateau耐心 (默认: 6)

# --------------- 模型架构参数 ---------------
# --gen_reduced_channel:  生成器通道数 (默认: 32)
# --des_reduced_channel:  描述器通道数 (默认: 64)
# --feat_channel:         显著性特征通道数 (默认: 32)
# --latent_dim:           潜在空间维度 (默认: 3)

# --------------- EBM 相关参数 ---------------
# --langevin_step_num_des:  Langevin步骤数 (默认: 10)
# --langevin_step_size_des: Langevin步长 (默认: 0.026)
# --energy_form:            能量函数形式 (默认: identity)
#                          选项: tanh | sigmoid | identity | softplus

# --------------- 损失权重参数 ---------------
# --sm_weight:         平滑性损失权重 (默认: 0.1)
# --reg_weight:        L2正则化损失权重 (默认: 1e-4)
# --lat_weight:        潜在损失权重 (默认: 10.0)
# --vae_loss_weight:   VAE损失权重 (默认: 0.4)

# --------------- 数据和保存路径 ---------------
# --dataset_path:      训练数据集路径 (默认: data/ijmond_data/train)
# --save_model_path:   模型保存路径 (默认: models/full-supervision)
# --pretrained_weights: 预训练权重路径 (默认: None)

# --------------- 校验相关参数 ---------------
# --val_split:         校验集比例 (默认: 0.2)
# --patience:          早停耐心值 (默认: 15)
# --min_delta:         早停最小改善阈值 (默认: 0.001)

# --------------- 数据增强和可重现性 ---------------
# --aug:               启用数据增强 (默认: False, 加 --aug 启用)
# --freeze:            固定随机性 (默认: False, 加 --freeze 启用)
# --random_seed:       随机种子 (默认: 42)

# ============================================================================

# 创建日志目录
mkdir -p logs_out logs_err

# 加载执行环境
module purge
module load 2024
source ~/anaconda3/etc/profile.d/conda.sh
source activate dl2024 || { echo "Failed to activate Conda env"; exit 1; }

# ============================================================================
# 多数据集训练配置 - 控制变量实验
# ============================================================================

# 通用训练参数（所有模型使用相同参数确保控制变量）
COMMON_PARAMS="--epoch 50 --batchsize 8 --trainsize 352 --lr_gen 2.5e-5 --lr_des 2.5e-5 --beta 0.5 --clip 0.5 --decay_rate 0.9 --decay_epoch 6 --gen_reduced_channel 32 --des_reduced_channel 64 --feat_channel 32 --latent_dim 3 --langevin_step_num_des 10 --langevin_step_size_des 0.026 --energy_form identity --sm_weight 0.1 --reg_weight 1e-4 --lat_weight 10.0 --vae_loss_weight 0.4 --val_split 0.2 --patience 15 --min_delta 0.001 --aug --random_seed 42"

echo "=========================================="
echo "开始多数据集BVM模型训练"
echo "时间: $(date)"
echo "=========================================="

# ============================================================================
# 模型 1: SMOKE5K 完全监督训练数据集
# ============================================================================
echo ""
echo "🚀 [1/3] 开始训练 SMOKE5K 完全监督模型..."
echo "数据集: data/SMOKE5K_Dataset/SMOKE5K/train"
echo "保存路径: models/full-supervision/SMOKE5K-supervised"
echo "------------------------------------------"

python ijmond-camera-ai/bvm_training/trans_bvm/train.py \
$COMMON_PARAMS \
--dataset_path "data/SMOKE5K_Dataset/SMOKE5K/train" \
--save_model_path "models/full-supervision/SMOKE5K-supervised"

TRAIN1_EXIT_CODE=$?
if [ $TRAIN1_EXIT_CODE -eq 0 ]; then
    echo "✅ SMOKE5K 完全监督模型训练完成"
else
    echo "❌ SMOKE5K 完全监督模型训练失败，退出码: $TRAIN1_EXIT_CODE"
    echo "继续下一个模型训练..."
fi

# ============================================================================
# 模型 2: SMOKE5K 弱监督训练数据集
# ============================================================================
echo ""
echo "🚀 [2/3] 开始训练 SMOKE5K 弱监督模型..."
echo "数据集: data/SMOKE5K_Dataset/SMOKE5K/weak_supervision"
echo "保存路径: models/full-supervision/SMOKE5K-weak-supervised"
echo "------------------------------------------"

python ijmond-camera-ai/bvm_training/trans_bvm/train.py \
$COMMON_PARAMS \
--dataset_path "data/SMOKE5K_Dataset/SMOKE5K/weak_supervision" \
--save_model_path "models/full-supervision/SMOKE5K-weak-supervised"

TRAIN2_EXIT_CODE=$?
if [ $TRAIN2_EXIT_CODE -eq 0 ]; then
    echo "✅ SMOKE5K 弱监督模型训练完成"
else
    echo "❌ SMOKE5K 弱监督模型训练失败，退出码: $TRAIN2_EXIT_CODE"
    echo "继续下一个模型训练..."
fi

# ============================================================================
# 模型 3: IJmond 测试数据集
# ============================================================================
echo ""
echo "🚀 [3/3] 开始训练 IJmond Test模型..."
echo "数据集: data/ijmond_data/test"
echo "保存路径: models/full-supervision/IJmond-test"
echo "------------------------------------------"

python ijmond-camera-ai/bvm_training/trans_bvm/train.py \
$COMMON_PARAMS \
--dataset_path "data/ijmond_data/test" \
--save_model_path "models/full-supervision/IJmond-test"

TRAIN3_EXIT_CODE=$?
if [ $TRAIN3_EXIT_CODE -eq 0 ]; then
    echo "✅ IJmond 模型训练完成"
else
    echo "❌ IJmond 模型训练失败，退出码: $TRAIN3_EXIT_CODE"
fi

# ============================================================================
# 训练总结
# ============================================================================
echo ""
echo "=========================================="
echo "多数据集训练完成总结"
echo "时间: $(date)"
echo "=========================================="
echo "训练结果:"
echo "  [1] SMOKE5K 完全监督: $([ $TRAIN1_EXIT_CODE -eq 0 ] && echo '✅ 成功' || echo '❌ 失败')"
echo "  [2] SMOKE5K 弱监督:   $([ $TRAIN2_EXIT_CODE -eq 0 ] && echo '✅ 成功' || echo '❌ 失败')"
echo "  [3] IJmond 测试:      $([ $TRAIN3_EXIT_CODE -eq 0 ] && echo '✅ 成功' || echo '❌ 失败')"
echo ""
echo "模型保存位置:"
echo "  🔹 models/full-supervision/SMOKE5K-supervised/"
echo "  🔹 models/full-supervision/SMOKE5K-weak-supervised/"
echo "  🔹 models/full-supervision/IJmond-test/"
echo ""
echo "所有训练使用相同参数以确保控制变量:"
echo "  • 数据增强: 启用 (--aug)"
echo "  • 随机种子: 42 (确保可重现性)"
echo "  • 训练轮数: 50"
echo "  • 批次大小: 7"
echo "  • 学习率: 2.5e-5"
echo "  • 早停策略: 启用 (patience=15)"
echo "=========================================="

# 总体退出码
OVERALL_SUCCESS=0
if [ $TRAIN1_EXIT_CODE -ne 0 ] || [ $TRAIN2_EXIT_CODE -ne 0 ] || [ $TRAIN3_EXIT_CODE -ne 0 ]; then
    OVERALL_SUCCESS=1
    echo "⚠️ 部分训练失败，请检查日志文件"
fi

exit $OVERALL_SUCCESS